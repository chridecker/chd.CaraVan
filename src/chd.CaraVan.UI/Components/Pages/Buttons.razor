@page "/buttons"
@inject IAESManager manager
@inject IPiManager piManager
@inject IOptionsMonitor<PiSettings> options

@using chd.CaraVan.Devices
@using chd.CaraVan.Devices.Contracts.Dtos.Pi
@using chd.CaraVan.UI.Components.Pages.Cards
<div style="display:grid">
    @foreach (var pin in options.CurrentValue.Gpios.Where(x => x.Type != Devices.Contracts.Enums.GpioType.None).OrderByDescending(o => o.Type).ThenBy(t => t.Name))
    {
        <SmartButton Checked="this.State(pin)" CheckedChanged="(x)=>Change(pin,x)" Text="@pin.Name"></SmartButton>
    }
</div>
@code {
    private async Task<bool> State(Gpio pin)
    {
        if (pin.Type == Devices.Contracts.Enums.GpioType.Aes)
        {
            return await manager.IsActive;
        }
        else if (pin.Type == Devices.Contracts.Enums.GpioType.Switch)
        {
            return await piManager.Read(pin.Pin);
        }
        return false;
    }
    private async Task Change(Gpio pin, bool val)
    {
        if (pin.Type == Devices.Contracts.Enums.GpioType.Aes)
        {
            if (val)
            {
                await manager.SetActive();
            }
            else
            {
                await manager.Off();
            }
        }
        else if (pin.Type == Devices.Contracts.Enums.GpioType.Switch)
        {
            await piManager.Write(pin.Pin, val);
        }
    }
}
